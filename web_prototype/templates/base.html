<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}BeatFinder{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    typography: {
                        DEFAULT: {
                            css: {
                                maxWidth: 'none',
                            },
                        },
                    },
                },
            },
            plugins: [],
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .prose h1 { @apply text-2xl font-bold mt-6 mb-4; }
            .prose h2 { @apply text-xl font-bold mt-5 mb-3; }
            .prose h3 { @apply text-lg font-semibold mt-4 mb-2; }
            .prose p { @apply my-2; }
            .prose ul { @apply list-disc ml-6 my-2; }
            .prose ol { @apply list-decimal ml-6 my-2; }
            .prose li { @apply my-1; }
            .prose strong { @apply font-semibold; }
            .prose code { @apply bg-slate-100 px-1 rounded text-sm; }
        }
    </style>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Chart.js for visualisations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Custom Tailwind config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom styles for range sliders */
        input[type="range"] {
            @apply w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            @apply appearance-none w-5 h-5 bg-primary-500 rounded-full cursor-pointer hover:bg-primary-600 transition-colors;
        }

        input[type="range"]::-moz-range-thumb {
            @apply w-5 h-5 bg-primary-500 rounded-full cursor-pointer hover:bg-primary-600 transition-colors border-0;
        }

        /* HTMX loading indicator */
        .htmx-request .htmx-indicator {
            display: inline-block;
        }

        .htmx-indicator {
            display: none;
        }

        /* Smooth transitions */
        .htmx-swapping {
            opacity: 0;
            transition: opacity 200ms ease-out;
        }

        /* Algorithm stage colour coding */
        .stage-input { border-left: 4px solid #3B82F6; }      /* Blue */
        .stage-taste { border-left: 4px solid #10B981; }      /* Green */
        .stage-filter { border-left: 4px solid #F59E0B; }     /* Orange */
        .stage-scoring { border-left: 4px solid #8B5CF6; }    /* Purple */

        .stage-header {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .stage-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            font-size: 0.625rem;
            font-weight: 700;
        }

        .stage-input .stage-number { background-color: #3B82F6; color: white; }
        .stage-taste .stage-number { background-color: #10B981; color: white; }
        .stage-filter .stage-number { background-color: #F59E0B; color: white; }
        .stage-scoring .stage-number { background-color: #8B5CF6; color: white; }
    </style>
</head>
<body class="h-full">
    <div class="min-h-full">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="w-full px-4 py-4 sm:px-6 lg:px-8">
                <!-- Tabs -->
                <div class="flex gap-2 border-b border-slate-200">
                    <button onclick="showTab('config')" id="tab-config" class="tab-button px-4 py-2 text-sm font-medium text-slate-900 border-b-2 border-primary-600">
                        Configuration
                    </button>
                    <button onclick="showTab('results')" id="tab-results" class="tab-button px-4 py-2 text-sm font-medium text-slate-600 border-b-2 border-transparent hover:text-slate-900 hover:border-slate-300">
                        Results
                    </button>
                    <button onclick="showTab('visualisation')" id="tab-visualisation" class="tab-button px-4 py-2 text-sm font-medium text-slate-600 border-b-2 border-transparent hover:text-slate-900 hover:border-slate-300">
                        Visualisation
                    </button>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main>
            <div class="w-full px-4 py-8 sm:px-6 lg:px-8">
                {% block content %}{% endblock %}
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-slate-200 mt-12">
            <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
                <p class="text-center text-sm text-slate-600">
                    BeatFinder Prototype â€¢ Flask + HTMX + Tailwind CSS
                </p>
            </div>
        </footer>
    </div>

    <script>
        // Tab switching
        function showTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Show selected tab content
            document.getElementById('tab-content-' + tabName).classList.remove('hidden');

            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('text-slate-900', 'border-primary-600');
                button.classList.add('text-slate-600', 'border-transparent');
            });

            document.getElementById('tab-' + tabName).classList.remove('text-slate-600', 'border-transparent');
            document.getElementById('tab-' + tabName).classList.add('text-slate-900', 'border-primary-600');

            // Load data when switching to Results or Visualisation tabs
            if (tabName === 'results' && typeof loadResults === 'function') {
                loadResults();
            } else if (tabName === 'visualisation' && typeof loadVisualisation === 'function') {
                loadVisualisation();
            }
        }

        // Export/Import Settings
        function exportSettings() {
            // Collect all form data from config
            const settings = {
                rarity_preference: parseInt(document.querySelector('[name="rarity"]').value),
                max_recommendations: parseInt(document.querySelector('[name="max_recommendations"]').value),
                known_artist_min_play_count: parseInt(document.querySelector('[name="known_play_count"]').value),
                loved_play_count_threshold: parseInt(document.querySelector('[name="loved_play_count"]').value),
                enable_tag_similarity: document.querySelector('[name="enable_tag_similarity"]').checked,
                enable_play_frequency_weighting: document.querySelector('[name="enable_play_frequency_weighting"]').checked,
                REC_TAG_BLACKLIST: document.getElementById('tag-blacklist-input').value.split(',').filter(t => t.trim()),
                tag_ignore_list: document.getElementById('tag-ignore-input').value.split(',').filter(t => t.trim()),
                date_from: document.querySelector('[name="date_from"]').value,
                date_to: document.querySelector('[name="date_to"]').value,
                data_source: document.querySelector('[name="data_source"]:checked').value,
                exported_at: new Date().toISOString()
            };

            // Download as JSON
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'beatfinder-settings-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importSettings(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);

                    // Apply settings to form
                    if (settings.rarity_preference) {
                        document.querySelector('[name="rarity"]').value = settings.rarity_preference;
                        document.getElementById('rarity-value').textContent = settings.rarity_preference;
                    }
                    if (settings.max_recommendations) {
                        document.querySelector('[name="max_recommendations"]').value = settings.max_recommendations;
                        document.getElementById('max-recs-value').textContent = settings.max_recommendations;
                    }
                    if (settings.known_artist_min_play_count) {
                        document.querySelector('[name="known_play_count"]').value = settings.known_artist_min_play_count;
                        document.getElementById('known-play-value').textContent = settings.known_artist_min_play_count;
                    }
                    if (settings.loved_play_count_threshold) {
                        document.querySelector('[name="loved_play_count"]').value = settings.loved_play_count_threshold;
                        document.getElementById('loved-play-value').textContent = settings.loved_play_count_threshold;
                    }
                    if (typeof settings.enable_tag_similarity !== 'undefined') {
                        document.querySelector('[name="enable_tag_similarity"]').checked = settings.enable_tag_similarity;
                    }
                    if (typeof settings.enable_play_frequency_weighting !== 'undefined') {
                        document.querySelector('[name="enable_play_frequency_weighting"]').checked = settings.enable_play_frequency_weighting;
                    }
                    if (settings.REC_TAG_BLACKLIST) {
                        window.blacklistTags = settings.REC_TAG_BLACKLIST;
                        window.updateTagDisplay('blacklist');
                        window.updateTagInput('blacklist');
                    }
                    if (settings.tag_ignore_list) {
                        window.ignoreTags = settings.tag_ignore_list;
                        window.updateTagDisplay('ignore');
                        window.updateTagInput('ignore');
                    }
                    if (settings.date_from) {
                        document.querySelector('[name="date_from"]').value = settings.date_from;
                    }
                    if (settings.date_to) {
                        document.querySelector('[name="date_to"]').value = settings.date_to;
                    }

                    alert('Settings imported successfully!');
                } catch (err) {
                    alert('Error importing settings: ' + err.message);
                }
            };
            reader.readAsText(file);

            // Reset input
            input.value = '';
        }
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
